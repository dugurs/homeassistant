blueprint:
  source_url: https://github.com/dugurs/homeassistant/blob/main/blueprints/automation/dehumidifier_switch_control/dehumidifier_switch_control.yaml
  name: 제습기 스위치 제어
  description:
    "습도 설정이 불가능한 제습기 제어용.\n v1.0\n ---------\n 필요 구성요소는
    switch 또는 dehumidifier 그리고 humidity sensor 입니다.\n 밤, 낮으로 구분하여 켜기 끄기 습도를 설정 할수 있습니다."
  domain: automation
  input:
    dehumidifier_switch:
      name: 제습기 스위치
      description: switch 또는 dehumidifier 선택
      selector:
        entity:
          domain:
            - switch
            - dehumidifier
          multiple: false
    humidity_sensor:
      name: 습도 센서
      description: ""
      selector:
        entity:
          domain: sensor
          device_class: humidity
          multiple: false
    door_sensor:
      name: 도어 센서
      description: "문이 열리면 10초후에 제습기를 끕니다."
      selector:
        entity:
          domain: binary_sensor
          device_class:
            - door
            - window
          multiple: true
    day_switch_off:
      name: 낮에 끄기 습도
      description: 낮 시간에 설정 습도 이하면 스위치를 끄니다
      default: 47
      selector:
        number:
          min: 40.0
          max: 70.0
          unit_of_measurement: "%"
          mode: slider
          step: 1.0
    day_switch_on:
      name: 낮에 켜기 습도
      description: 낮 시간에 설정 습도 이상이면 스위치를 켭니다
      default: 52
      selector:
        number:
          min: 40.0
          max: 70.0
          unit_of_measurement: "%"
          mode: slider
          step: 1.0
    night_switch_off:
      name: 밤에 끄기 습도
      description: 밤 시간에 설정 습도 이하면 스위치를 끕니다
      default: 52
      selector:
        number:
          min: 40.0
          max: 70.0
          unit_of_measurement: "%"
          mode: slider
          step: 1.0
    night_switch_on:
      name: 밤에 켜기 습도
      description: 밤 시간에 설정 습도 이상이면 스위치를 켭니다
      default: 57
      selector:
        number:
          min: 40.0
          max: 70.0
          unit_of_measurement: "%"
          mode: slider
          step: 1.0
    day_time_after:
      name: 낮 시작 시간
      description: 부터
      default: "8:00:00"
      selector:
        time: {}
    day_time_before:
      name: 낮 끝 시간
      description: 까지
      default: "21:00:00"
      selector:
        time: {}

trigger:
  - platform: state
    entity_id: !input door_sensor
  - platform: time_pattern
    minutes: /1
    id: timePattern

variables:
  dehumidifier_switch: !input dehumidifier_switch
  door_sensor: !input door_sensor
  switch_domain: "{{ dehumidifier_switch.split('.')[0] }}"
  door_open: "{{ expand(door_sensor) | selectattr('state', 'eq', 'on') | list | count }}"

action:
  - if:
      - condition: template
        value_template: "{{ door_sensor | count > 0 }}"
      - condition: template
        value_template: "{{ door_open > 0 }}"
    then:
      - delay: "00:00:10"
      - service: "{{switch_domain}}.turn_off"
        data: {}
        target:
          entity_id: !input dehumidifier_switch
    else:
      - if:
          - condition: time
            after: !input day_time_after
            before: !input day_time_before
        then:
          - choose:
              - conditions:
                  - condition: numeric_state
                    entity_id: !input humidity_sensor
                    above: !input day_switch_off
                  - condition: state
                    state: "on"
                    entity_id: !input dehumidifier_switch
                sequence:
                  - service: "{{switch_domain}}.turn_off"
                    data: {}
                    target:
                      entity_id: !input dehumidifier_switch
              - conditions:
                  - condition: numeric_state
                    entity_id: !input humidity_sensor
                    below: !input day_switch_off
                  - condition: state
                    state: "off"
                    entity_id: !input dehumidifier_switch
                sequence:
                  - service: "{{switch_domain}}.turn_on"
                    data: {}
                    target:
                      entity_id: !input dehumidifier_switch
            default: []
        else:
          - choose:
              - conditions:
                  - condition: numeric_state
                    entity_id: !input humidity_sensor
                    above: !input night_switch_off
                  - condition: state
                    entity_id: !input dehumidifier_switch
                    state: "on"
                sequence:
                  - service: "{{switch_domain}}.turn_off"
                    data: {}
                    target:
                      entity_id: !input dehumidifier_switch
              - conditions:
                  - condition: numeric_state
                    entity_id: !input humidity_sensor
                    below: !input night_switch_off
                  - condition: state
                    state: "off"
                    entity_id: !input dehumidifier_switch
                sequence:
                  - service: "{{switch_domain}}.turn_on"
                    data: {}
                    target:
                      entity_id: !input dehumidifier_switch
            default: []
mode: restart
max_exceeded: silent
